name: ğŸ¥ Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ

on:
  workflow_dispatch:
    inputs:
      product_slug:
        description: 'Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ù…Ù†ØªØ¬ (Ø¹Ø±Ø¨ÙŠ Ø£Ùˆ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØŒ Ø¨Ø¯ÙˆÙ† .html)'
        required: true
        type: string
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø£ÙŠ Ø±Ø§Ø¨Ø· YouTube/Vimeo/TikTok)'
        required: true
        type: string

jobs:
  add-video:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install beautifulsoup4 lxml

      - name: Add Video to Product
        env:
          PRODUCT_SLUG: ${{ github.event.inputs.product_slug }}
          VIDEO_URL: ${{ github.event.inputs.video_url }}
        run: |
          python3 << 'EOF'
          import os
          import re
          import urllib.parse
          from pathlib import Path
          from bs4 import BeautifulSoup
          
          slug = os.environ['PRODUCT_SLUG']
          video_url = os.environ['VIDEO_URL']
          
          # ğŸ”„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ø¥Ù„Ù‰ embed
          def convert_to_embed(url):
              """ØªØ­ÙˆÙŠÙ„ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ embed"""
              
              # YouTube - ÙƒÙ„ Ø§Ù„Ø£Ø´ÙƒØ§Ù„
              youtube_patterns = [
                  r'(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})',
                  r'youtube\.com\/embed\/([a-zA-Z0-9_-]{11})',
                  r'youtube\.com\/v\/([a-zA-Z0-9_-]{11})',
                  r'youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})'
              ]
              
              for pattern in youtube_patterns:
                  match = re.search(pattern, url)
                  if match:
                      video_id = match.group(1)
                      return f"https://www.youtube.com/embed/{video_id}"
              
              # Vimeo
              vimeo_match = re.search(r'vimeo\.com\/(\d+)', url)
              if vimeo_match:
                  video_id = vimeo_match.group(1)
                  return f"https://player.vimeo.com/video/{video_id}"
              
              # TikTok
              tiktok_match = re.search(r'tiktok\.com\/.*\/video\/(\d+)', url)
              if tiktok_match:
                  video_id = tiktok_match.group(1)
                  return f"https://www.tiktok.com/embed/v2/{video_id}"
              
              # Dailymotion
              dailymotion_match = re.search(r'dailymotion\.com\/video\/([a-zA-Z0-9]+)', url)
              if dailymotion_match:
                  video_id = dailymotion_match.group(1)
                  return f"https://www.dailymotion.com/embed/video/{video_id}"
              
              # Ù„Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· embed Ø¨Ø§Ù„ÙØ¹Ù„
              if 'embed' in url or 'player' in url:
                  return url
              
              return url
          
          # ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ ÙƒÙ„ Ø§Ù„Ø±ÙŠØ¨Ùˆ (Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ)
          def find_product_file(slug):
              """Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ ÙƒÙ„ Ù…ÙƒØ§Ù† - ÙŠØ¯Ø¹Ù… Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"""
              
              # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ slug
              slug_clean = slug.strip()
              
              # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„ Ù…Ù„ÙØ§Øª HTML ÙÙŠ Ø§Ù„Ø±ÙŠØ¨Ùˆ
              all_html_files = list(Path('.').rglob("*.html"))
              
              # Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨Ø©
              excluded_dirs = {'.git', 'node_modules', '.github', '__pycache__', 'vendor', 'dist', 'build'}
              
              # ØªØµÙÙŠØ© Ø§Ù„Ù…Ù„ÙØ§Øª
              valid_files = []
              for file in all_html_files:
                  # Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
                  if any(excl in file.parts for excl in excluded_dirs):
                      continue
                  
                  # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† Ø§Ù…ØªØ¯Ø§Ø¯
                  filename_without_ext = file.stem
                  
                  # Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
                  if filename_without_ext == slug_clean:
                      valid_files.append(file)
                      continue
                  
                  # Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ URL encoding Ù„Ù„Ø¹Ø±Ø¨ÙŠ
                  try:
                      decoded_filename = urllib.parse.unquote(filename_without_ext)
                      if decoded_filename == slug_clean:
                          valid_files.append(file)
                          continue
                  except:
                      pass
                  
                  # Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ URL encoded slug
                  try:
                      encoded_slug = urllib.parse.quote(slug_clean)
                      if filename_without_ext == encoded_slug:
                          valid_files.append(file)
                  except:
                      pass
              
              if valid_files:
                  # Ø¥Ø°Ø§ ÙˆØ¬Ø¯ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù„ÙØŒ Ø§Ø®ØªØ± Ø§Ù„Ø£Ù‚Ø±Ø¨ Ù„Ù„Ù€ root
                  valid_files.sort(key=lambda x: len(x.parts))
                  return str(valid_files[0])
              
              return None
          
          # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø·
          embed_url = convert_to_embed(video_url)
          print(f"ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ØµÙ„ÙŠ: {video_url}")
          print(f"âœ… Ø±Ø§Ø¨Ø· Embed: {embed_url}")
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù
          print(f"\nğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†: {slug}")
          product_file = find_product_file(slug)
          
          if not product_file:
              print(f"\nâŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù")
              print(f"ğŸ’¡ ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ø¨Ø¯ÙˆÙ† .html)")
              print(f"   Ø¨Ø­Ø«Øª Ø¹Ù†: {slug}")
              
              # Ø¹Ø±Ø¶ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙƒÙ…Ø³Ø§Ø¹Ø¯Ø©
              print(f"\nğŸ“ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª HTML Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:")
              all_html = list(Path('.').rglob("*.html"))
              excluded = {'.git', 'node_modules', '.github'}
              shown = 0
              for f in all_html:
                  if not any(e in f.parts for e in excluded) and shown < 10:
                      print(f"   - {f.stem}")
                      shown += 1
              
              exit(1)
          
          print(f"âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù ÙÙŠ: {product_file}")
          
          # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù
          with open(product_file, 'r', encoding='utf-8') as f:
              soup = BeautifulSoup(f.read(), 'html.parser')
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
          existing_video = soup.find('iframe', src=lambda x: x and (embed_url in x or video_url in x))
          if existing_video:
              print("\nâš ï¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©")
              print("âœ… Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ø¶Ø§ÙØªÙ‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")
              exit(0)
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
          video_html = f'''
          <div class="product-video" style="margin: 25px 0;">
              <h3 style="font-size: 1.5rem; margin-bottom: 15px; color: #2c3e50; font-weight: 600;">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ù†ØªØ¬</h3>
              <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); background: #000;">
                  <iframe 
                      src="{embed_url}" 
                      style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"
                      frameborder="0" 
                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                      allowfullscreen
                      loading="lazy">
                  </iframe>
              </div>
          </div>
          '''
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ (Ø¨ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©)
          selectors = [
              # Ù‚Ø³Ù… Ø§Ù„ÙˆØµÙ
              ('div', {'class': 'product-description'}),
              ('div', {'class': 'description'}),
              ('div', {'class': 'product-desc'}),
              
              # Ù‚Ø³Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„
              ('section', {'class': 'product-details'}),
              ('section', {'class': 'details'}),
              ('div', {'class': 'product-details'}),
              
              # Ø§Ù„Ù…Ø­ØªÙˆÙ‰
              ('div', {'class': 'product-content'}),
              ('div', {'class': 'content'}),
              ('div', {'class': 'product-info'}),
              
              # Ø¹Ù†Ø§ØµØ± Ø¹Ø§Ù…Ø©
              ('article', {'class': 'product'}),
              ('article', {}),
              ('main', {}),
              
              # Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
              ('div', {'class': 'container'}),
              ('div', {'class': 'wrapper'}),
              
              # Ø¢Ø®Ø± Ø®ÙŠØ§Ø±
              ('body', {})
          ]
          
          insertion_point = None
          selected_selector = None
          
          for tag, attrs in selectors:
              if attrs:
                  element = soup.find(tag, attrs)
              else:
                  element = soup.find(tag)
              
              if element:
                  insertion_point = element
                  selected_selector = f"<{tag} {' '.join(f'{k}=\"{v}\"' for k, v in attrs.items()) if attrs else ''}>"
                  break
          
          if insertion_point:
              print(f"ğŸ“ Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙÙŠ: {selected_selector}")
              
              video_tag = BeautifulSoup(video_html, 'html.parser')
              insertion_point.insert(0, video_tag)
              
              with open(product_file, 'w', encoding='utf-8') as f:
                  f.write(str(soup.prettify()))
              
              print(f"\nâœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!")
              print(f"ğŸ“„ Ø§Ù„Ù…Ù„Ù: {product_file}")
              print(f"ğŸ¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: {embed_url}")
          else:
              print("\nâŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙƒØ§Ù† Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ")
              print("ğŸ’¡ Ø¨Ù†ÙŠØ© HTML ÙÙŠ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù‚ÙŠØ§Ø³ÙŠØ©")
              print("ğŸ”§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ selectors ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù„ØªÙ†Ø§Ø³Ø¨ Ø¨Ù†ÙŠØ© Ù…ÙˆÙ‚Ø¹Ùƒ")
              exit(1)
          EOF

      - name: Commit Changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add -A
          git diff --staged --quiet || git commit -m "ğŸ¥ Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ: ${{ github.event.inputs.product_slug }}"
          git push
